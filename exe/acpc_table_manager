#!/usr/bin/env ruby

require 'acpc_table_manager'
require 'redis'
require 'json'
require 'optparse'


ARGV << '-h' if ARGV.empty?

options = {}
OptionParser.new do |opts|
  opts.banner = "Usage: #{$0} [options]"

  opts.on_tail("-h", "--help", "Show this message") do
    puts opts
    exit
  end

  opts.on("-t", "--table_manager TABLE MANAGER CONFIG", "Table manager configuration file.") do |c|
    options[:table_manager_config] = File.expand_path c, Dir.pwd
  end
end.parse!

raise OptionParser::MissingArgument.new('TABLE MANAGER CONFIG') unless options[:table_manager_config]

raise OptionParser::ArgumentError.new("#{options[:table_manager_config]} doesn't exist.") unless File.exist?(options[:table_manager_config])

CONFIG_FILE = options[:table_manager_config]

AcpcTableManager.load! CONFIG_FILE
table_manager = AcpcTableManager::Maintainer.new
loop do
  begin
    message = AcpcTableManager.redis.blpop("table-manager", :timeout => AcpcTableManager.config.maintenance_interval_s)
    if message
      data = JSON.parse message[1]
      case data['request']
      when AcpcTableManager.config.start_match_request_code
        table_manager.enqueue_match!(
          data['params'][AcpcTableManager.config.match_id_key],
          data['params'][AcpcTableManager.config.options_key]
        )
      when AcpcTableManager.config.kill_match
        table_manager.kill_match! match_id
      when 'reload'
        AcpcTableManager.load! CONFIG_FILE
      when AcpcTableManager.config.check_match
        table_manager.check_match data['params'][AcpcTableManager.config.match_id_key]
      when AcpcTableManager.config.delete_irrelevant_matches_request_code
        table_manager.clean_up_matches!
      else
        raise StandardError.new("Unrecognized request: #{data['request']}")
      end
    else
      table_manager.maintain!
    end
  rescue => e
    table_manager.log(
      __method__,
      {
        message: e.message,
        backtrace: e.backtrace
      },
      Logger::Severity::ERROR
    )
    Rusen.notify e # Send an email notification
  end
end
